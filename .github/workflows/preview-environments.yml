name: Generate preview environment

on:
  pull_request:
    types: [opened, reopened, synchronize]

env:
  ENVIRONMENT_NAME: "${GITHUB_REPOSITORY:8}-${GITHUB_REF:11}"

jobs:
  create_environment:
    name: Create environment
    runs-on: ubuntu-latest
    container:
      image: node:10
    steps:
      - uses: actions/setup-node@v1
        with:
          node-version: '10.x'
      - uses: actions/checkout@v2
        with:
          ref: 'gh-actions-test'
          repository: 'architect-team/architect-cli'
      - run: npm link
      - name: Install Docker
        run: |
          apt-get update
          apt-get install -y apt-transport-https ca-certificates curl software-properties-common sudo
          curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo apt-key add â€“
          add-apt-repository "deb [arch=amd64] https://download.docker.com/linux/ubuntu  $(lsb_release -cs)  stable" 
          apt-get update
          apt-get install -y docker-ce
          docker --version
      - name: Login to Architect
        run: architect login -u "${{ secrets.ARCHITECT_USERNAME }}" -p "${{ secrets.ARCHITECT_PASSWORD }}"
      - name: Create preview environment
        run: architect env:create "${ENVIRONMENT_NAME}" --platform "preview-platform"
      - name: Deploy to preview environment
        run: architect deploy preview.env.json --environment "${ENVIRONMENT_NAME}"