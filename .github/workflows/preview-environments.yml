name: Generate preview environment

on:
  pull_request:
    types: [opened, reopened, synchronize]

env:
  ENVIRONMENT_NAME: "${GITHUB_REPOSITORY:8}-${GITHUB_REF:11}"

jobs:
  create_environment:
    name: Create environment
    runs-on: ubuntu-latest
    container:
      image: node:10
    steps:
      - uses: actions/setup-node@v1
        with:
          node-version: '10.x'
      - uses: actions/checkout@v2
        with:
          ref: 'gh-actions-test'
          repository: 'architect-team/architect-cli'
      - run: npm link
      - name: Install Docker
        run: |
          apt-get update
          apt-get remove docker docker-engine docker.io
          apt install docker.io
          systemctl start docker
          systemctl enable docker
          docker --version
      - name: Login to Architect
        run: architect login -u "${{ secrets.ARCHITECT_USERNAME }}" -p "${{ secrets.ARCHITECT_PASSWORD }}"
      - name: Create preview environment
        run: architect env:create "${ENVIRONMENT_NAME}" --platform "preview-platform"
      - name: Deploy to preview environment
        run: architect deploy preview.env.json --environment "${ENVIRONMENT_NAME}"